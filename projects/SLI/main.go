// –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É, –∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞, –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
package main

import (
	"flag"
	"fmt"
	"os"
	"time"
)

// Config —Ö—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ —Ñ–ª–∞–≥–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
type Config struct {
	DirPath string        // –ü—É—Ç—å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
	Mode    string        // –†–µ–∂–∏–º: name_size, hash, combined
	Workers int           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω
	Tick    time.Duration // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
}

func main() {
	// 1. –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–ª–∞–≥–æ–≤ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CLI)
	pathPtr := flag.String("path", ".", "–ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
	modePtr := flag.String("mode", "hash", "–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞: name_size (–∏–º—è+—Ä–∞–∑–º–µ—Ä), hash (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ), combined (–∏–º—è+—Ä–∞–∑–º–µ—Ä+—Ö—ç—à)")
	workersPtr := flag.Int("workers", 8, "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤")
	tickPtr := flag.Duration("tick", 500*time.Millisecond, "–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 500ms)")

	//–ß–∏—Ç–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
	flag.Parse()

	cfg := Config{
		DirPath: *pathPtr,
		Mode:    *modePtr,
		Workers: *workersPtr,
		Tick:    *tickPtr,
	}

	fmt.Printf("üöÄ –ó–∞–ø—É—Å–∫ DupliFinder\nüìÇ –ü–∞–ø–∫–∞: %s\n‚öô –†–µ–∂–∏–º: %s\nüë∑‚Äç‚ôÇÔ∏èüë∑‚Äç‚ôÄÔ∏è –í–æ—Ä–∫–µ—Ä–æ–≤: %d\n\n", cfg.DirPath, cfg.Mode, cfg.Workers)
	startTime := time.Now() // –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞

	// 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
	scanner := NewScanner(cfg)

	// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ
	// time.NewTicker —Å–æ–∑–¥–∞–µ—Ç –∫–∞–Ω–∞–ª, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Ö–æ–¥—è—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ –• –≤—Ä–µ–º–µ–Ω–∏
	done := make(chan bool)
	ticker := time.NewTicker(cfg.Tick)
	go func() {
		for {
			select {
			case <-done: // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è - –≤—ã—Ö–æ–¥–∏–º
				return
			case <-ticker.C: // –ö–∞–∂–¥–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ä–∞
				stats := scanner.GetStats()
				// \r –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ä–µ—Ç–∫—É –≤ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏, –ø–æ–∑–≤–æ–ª—è—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç (—ç—Ñ—Ñ–µ–∫—Ç –∞–Ω–∏–º–∞—Ü–∏–∏)
				fmt.Printf("\rüîé –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: %d| –ù–∞–π–¥–µ–Ω–æ –≥—Ä—É–ø–ø –¥—É–ø–ª–∏–∫–∞—Ç–æ–≤: %d | –û—à–∏–±–æ–∫: %d",
					stats.TotalFiles, stats.DuplicateGroups, stats.Errors)
			}
		}
	}()

	// 3. –û—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ (–ë–ª–æ–∫–∏—Ä—É—é—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
	duplicates, err := scanner.Run()

	// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–∫–µ—Ä –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
	ticker.Stop()
	done <- true
	fmt.Println() // –ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞

	if err != nil {
		fmt.Printf("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: %v,\n", err)
		os.Exit(1)
	}

	// 4. –í—ã–≤–æ–¥ –ø–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
	fmt.Println("\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:")
	if len(duplicates) == 0 {
		fmt.Println("–î—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
	} else {
		for i, group := range duplicates {
			fmt.Printf("–ì—Ä—É–ø–ø–∞ #%d (–§–∞–π–ª–æ–≤ %d)\n", i+1, len(group))
			for _, file := range group {
				fmt.Printf("  üìÑ %s (%d bytes)\n", file.Path, file.Size)
			}
			fmt.Println()
		}
	}

	fmt.Printf("\n‚è±  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: %s\n", time.Since(startTime))

}
